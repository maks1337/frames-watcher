var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},FrameWatcher;!function(t){var e=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.width=0,this.height=0,this.iframe=!1,this.setSize(t,e),this.setMetadata()}return t.prototype.setMetadata=function(){this.iframe=window.location!==window.parent.location,this.url=window.location.href,this.domain=window.location.hostname},t.prototype.getSize=function(){return{width:this.width,height:this.height}},t.prototype.setSize=function(t,e){t>0&&e>0?(this.width=t,this.height=e):(this.width=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,this.height=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight)},t}();t.Context=e}(FrameWatcher||(FrameWatcher={}));var FrameWatcher;!function(t){var e=function(){function t(t,e){this.viewed=[],this._timeline=[];var n=document.getElementById(t);if(!(n instanceof Object))throw new Error("Invalid hook id");this.element=this.getHookParent(n),this.id=this.element.id,this.code=e}return t.prototype.getHookParent=function(t){return t.parentElement},t.prototype.getTimeline=function(){return this._timeline},t.prototype.addToTimeline=function(t){t>0&&this._timeline.push(t)},t.prototype.getSize=function(){return{width:this.element.offsetWidth,height:this.element.offsetHeight}},t.prototype.getRects=function(){if(!(this.element instanceof Object))throw new Error("FrameElement element in not a proper object");if("getClientRects"in this.element)return this.rects=this.element.getClientRects()[0],this.rects;throw new Error("FrameElement can't get element rects")},t}();t.Element=e}(FrameWatcher||(FrameWatcher={}));var FrameWatcher;!function(t){var e=function(){function t(t,e){this.element=t,this.context=e,this.calculate()}return t.prototype.lessThanZero=function(t){return t<0?0:t},t.prototype.inView=function(t,e){var n=t.bottom>0||t.top>0,i=t.top<e.height,r=t.left<e.width;return n&&i&&r},t.prototype.percent=function(t,e,n){return Math.round(t*e/n*Math.pow(10,2))/Math.pow(10,2)},t.prototype.greaterThanElementSize=function(t,e){var n=this.element.getSize().$distance;return e=this.lessThanZero(e),e>n?n:e},t.prototype.calculate=function(){var t=this.element.getRects(),e=this.context.getSize(),n=this.element.getSize().height,i=this.element.getSize().width,r=this.element.getSize().height*this.element.getSize().width;return t.top<0&&(n=this.greaterThanElementSize("height",n+t.top)),e.width<t.right&&(i=this.greaterThanElementSize("width",e.width-t.left)),t.bottom>e.height&&(n=this.greaterThanElementSize("height",t.bottom-e.height)),t.left<0&&(i=this.greaterThanElementSize("width",i+t.left)),this.inView(t,e)?this.percent(i,n,r):0},t}();t.Estimation=e}(FrameWatcher||(FrameWatcher={}));var FrameWatcher;!function(t){var e=function(){function t(){this.NAME="basic"}return t.prototype.validate=function(t){return t.sort()[t.length-1]>=.5},t}();t.BasicStrategy=e;var n=function(){function t(){this.NAME="full"}return t.prototype.validate=function(t){return 1===t.sort()[t.length-1]},t}();t.FullStrategy=n;var i=function(){function t(){this.NAME="long"}return t.prototype.validate=function(t){var e=t.reduce(function(t,e){return t[e]?t[e]++:t[e]=1,t},{});return e[1]?e[1]>=5:e[1]<5},t}();t.LongStrategy=i;var r=function(){function t(){this.NAME="time"}return t.prototype.validate=function(t){var e=t.reduce(function(t,e){return t[e]?t[e]++:t[e]=1,t},{});return e[1]?e[1]>=5:e[1]<5},t}();t.TimeStrategy=r;var o=function(){function t(t){this.strategy=t,this.name=t.NAME}return t.prototype.run=function(t){return this.strategy.validate(t)},t}();t.StrategyCheck=o}(FrameWatcher||(FrameWatcher={}));var FrameWatcher;!function(t){var e=function(){function t(){}return t.prototype.get=function(){for(var t=[],e=0;e<256;e++)t[e]=(e<16?"0":"")+e.toString(16);var n=4294967295*Math.random()|0,i=4294967295*Math.random()|0,r=4294967295*Math.random()|0,o=4294967295*Math.random()|0;return t[255&n]+t[n>>8&255]+t[n>>16&255]+t[n>>24&255]+"-"+t[255&i]+t[i>>8&255]+"-"+t[i>>16&15|64]+t[i>>24&255]+"-"+t[63&r|128]+t[r>>8&255]+"-"+t[r>>16&255]+t[r>>24&255]+t[255&o]+t[o>>8&255]+t[o>>16&255]+t[o>>24&255]},t}();t.UUID=e;var n=function(){function t(t,e,n){var i=this;this._data={code:t.code,placement:t.id,view:n},e&&(this._data.cookie=e),t.viewed.forEach(function(t){return i._data["strat-"+t[0]]=t[1]})}return Object.defineProperty(t.prototype,"data",{get:function(){return this._data},enumerable:!0,configurable:!0}),t}();t.Data=n;var i=function(){function t(t){this.url=void 0,this._cookie=void 0,this._viewId=void 0,this.url=t}return Object.defineProperty(t.prototype,"cookie",{get:function(){return this._cookie},set:function(t){this._cookie=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"viewId",{get:function(){return this._viewId},set:function(t){this._viewId=t},enumerable:!0,configurable:!0}),t.prototype.loadElements=function(t){this.elements=t},t.prototype.prepareData=function(){var t=this,e=[];return this.elements.forEach(function(i){var r=new n(i,t._cookie,t._viewId);e.push(r.data)}),e},t}();t.Sender=i;var r=function(t){function e(){return t.apply(this,arguments)||this}return __extends(e,t),e.prototype.generateUrlForData=function(t,e){var n=[];for(var i in t)n.push(i+"["+e+"]="+t[i]);return n.join("&")},e.prototype.prepareUrl=function(){for(var t=[],e=this.prepareData(),n=0,i=0,r=e;i<r.length;i++){var o=r[i];t.push(this.generateUrlForData(o,n)),n++}return"?="+t.join("&")},e.prototype.checkLastUrl=function(t){return t!==this.lastUrl},e.prototype.setLastUrl=function(t){this.lastUrl=t},e.prototype.send=function(){var t=this.prepareUrl();if(this.checkLastUrl(t)){this.setLastUrl(t);var e=document.createElement("img");e.src=t+"&stamp="+(new Date).getTime()}return!0},e}(i);t.HttpSender=r;var o=function(t){function e(){return t.apply(this,arguments)||this}return __extends(e,t),e.prototype.send=function(){this.prepareData();return!0},e}(i);t.SocketSender=o;var a=function(t){function e(){return t.apply(this,arguments)||this}return __extends(e,t),e.prototype.send=function(){var t=this,e=this.prepareData(),n=["placement","strat-basic"];return e.forEach(function(e){var i=[];for(var r in e)n.indexOf(r)>-1&&i.push(""+e[r]);console.log(t.url,i.join(" "))}),!0},e}(i);t.ConsoleSender=a;var s=function(){function t(t,e){if("http"===t&&(this.sender=new r(e)),"socket"===t&&(this.sender=new o(e)),"console"===t&&(this.sender=new a(e)),!this.sender.hasOwnProperty("url"))throw new Error("invalid sender requested: "+t)}return t.prototype.returnObject=function(){return this.sender},t}();t.SenderSelect=s}(FrameWatcher||(FrameWatcher={}));var FrameWatcher;!function(t){var e=function(){function e(e,n,i,r){void 0===e&&(e="http"),void 0===i&&(i=void 0),void 0===r&&(r=void 0),this.tickRate=1e3,this.timeLimit=6e5,this._elements=[],this._debug=!1,this._timeElapsed=this.tickRate,this._strategies=[],this.context=new t.Context,this.loadStrategies();try{var o=new t.SenderSelect(e,n);this._sender=o.returnObject(),this._sender.cookie=i,this._sender.viewId=r?r:(new t.UUID).get(),this.bindRuntime()}catch(t){console.log("Runner not started because: "+t)}}return Object.defineProperty(e.prototype,"debug",{get:function(){return this._debug},set:function(t){this._debug=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"sender",{get:function(){return this._sender},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"elements",{get:function(){return this._elements},enumerable:!0,configurable:!0}),e.prototype.sendData=function(){this._sender.loadElements(this._elements),this._sender.send()},e.prototype.loadStrategies=function(){var e=new t.StrategyCheck(new t.BasicStrategy),n=new t.StrategyCheck(new t.FullStrategy),i=new t.StrategyCheck(new t.LongStrategy),r=new t.StrategyCheck(new t.TimeStrategy);this._strategies[e.name]=e,this._strategies[n.name]=n,this._strategies[i.name]=i,this._strategies[r.name]=r},e.prototype.run=function(){try{this.checkElements(),this._timeElapsed+=this.tickRate,this.expireRuntime(),this.sendData()}catch(t){console.log("runtime stopped "+t),this.expireRuntime(!0)}},e.prototype.bindRuntime=function(){var t=this;this.run(),window.addEventListener("resize",function(){t.context.setSize(0,0)}),this._interval=setInterval(function(){return t.run()},this.tickRate)},e.prototype.expireRuntime=function(t){return void 0===t&&(t=!1),!!(this._timeElapsed>=this.timeLimit||t)&&(clearInterval(this._interval),!0)},e.prototype.checkElements=function(){this._debug===!0&&console.log("------ second: "+this._timeElapsed/1e3);for(var e=0,n=this._elements;e<n.length;e++){var i=n[e],r=new t.Estimation(i,this.context),o=r.calculate();i.addToTimeline(o),i.viewed=[];for(var a in this._strategies){var s=this._strategies[a];i.viewed.push([s.name,s.run(i.getTimeline())])}this._debug===!0&&console.log(i.id,i.code,o,i.viewed)}},e.prototype.registerElement=function(e,n){this._elements.push(new t.Element(e,n)),this.checkElements()},e}();t.Runner=e}(FrameWatcher||(FrameWatcher={}));